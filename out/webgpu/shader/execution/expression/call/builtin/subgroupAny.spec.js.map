{"version":3,"file":"subgroupAny.spec.js","names":["description","makeTestGroup","keysOf","iterRange","PRNG","kWGSizes","kPredicateCases","SubgroupTest","runComputeTest","kDataSentinel","g","kNumCases","generateInputData","seed","num","addCounter","prng","bound","Math","min","index","uniformInt","Uint32Array","x","bounded","checkAny","metadata","output","numInvs","input","filter","expected","Map","inv","size","id","subgroup_id","v","get","set","res","expected_v","Error","undefined","test","desc","params","u","combine","beginSubcases","beforeAllSubcases","t","selectDeviceOrSkipTestCase","fn","wgThreads","wgSize","wgsl","includeCounter","inputData","case","uintsPerOutput","testcase","predicate","cond","unimplemented"],"sources":["../../../../../../../src/webgpu/shader/execution/expression/call/builtin/subgroupAny.spec.ts"],"sourcesContent":["export const description = `\nExecution tests for subgroupAny.\n\nNote: There is a lack of portability for non-uniform execution so these tests\nrestrict themselves to uniform control flow.\nNote: There is no guaranteed mapping between subgroup_invocation_id and\nlocal_invocation_index. Tests should avoid assuming there is.\n`;\n\nimport { makeTestGroup } from '../../../../../../common/framework/test_group.js';\nimport { keysOf } from '../../../../../../common/util/data_tables.js';\nimport { iterRange } from '../../../../../../common/util/util.js';\nimport { PRNG } from '../../../../../util/prng.js';\n\nimport {\n  kWGSizes,\n  kPredicateCases,\n  SubgroupTest,\n  runComputeTest,\n  kDataSentinel,\n} from './subgroup_util.js';\n\nexport const g = makeTestGroup(SubgroupTest);\n\nconst kNumCases = 15;\n\n/**\n * Generate input data for testing.\n *\n * Data is generated in the following categories:\n * Seed 0 generates all 0 data\n * Seed 1 generates all 1 data\n * Seeds 2-9 generates all 0s except for a one randomly once per 32 elements\n * Seeds 10+ generate all random data\n * @param seed The seed for the PRNG\n * @param num The number of data items to generate\n * @param addCounter If true, treats the first index as an atomic counter\n */\nfunction generateInputData(seed: number, num: number, addCounter: boolean): Uint32Array {\n  const prng = new PRNG(seed);\n\n  const bound = Math.min(num, 32);\n  const index = prng.uniformInt(bound);\n\n  return new Uint32Array([\n    ...iterRange(num, x => {\n      if (addCounter && x === 0) {\n        // Counter should start at 1 to avoid clear value.\n        return 1;\n      }\n\n      if (seed === 0) {\n        return 0;\n      } else if (seed === 1) {\n        return 1;\n      } else if (seed < 10) {\n        const bounded = (addCounter ? x + 1 : x) % bound;\n        return bounded === index ? 1 : 0;\n      }\n      return prng.uniformInt(2);\n    }),\n  ]);\n}\n\n/**\n * Checks the result of a subgroupAny operation\n *\n * Since subgroup size depends on the pipeline compile, we calculate the expected\n * results after execution. The shader generates a subgroup id and records it for\n * each invocation. The check first calculates the expected result for each subgroup\n * and then compares to the actual result for each invocation. The filter functor\n * ensures only the correct invocations contribute to the calculation.\n * @param metadata An array of uints:\n *                 * first half containing subgroup sizes (from builtin value)\n *                 * second half subgroup invocation id\n * @param output An array of uints containing:\n *               * first half is the outputs of subgroupAny\n *               * second half is a generated subgroup id\n * @param numInvs Number of invocations executed\n * @param input The input data (equal size to output)\n * @param filter A functor to filter active invocations\n */\nfunction checkAny(\n  metadata: Uint32Array, // unused\n  output: Uint32Array,\n  numInvs: number,\n  input: Uint32Array,\n  filter: (id: number, size: number) => boolean\n): Error | undefined {\n  // First, generate expected results.\n  const expected = new Map<number, number>();\n  for (let inv = 0; inv < numInvs; inv++) {\n    const size = metadata[inv];\n    const id = metadata[inv + numInvs];\n    if (!filter(id, size)) {\n      continue;\n    }\n    const subgroup_id = output[numInvs + inv];\n    let v = expected.get(subgroup_id) ?? 0;\n    v |= input[inv];\n    expected.set(subgroup_id, v);\n  }\n\n  // Second, check against actual results.\n  for (let inv = 0; inv < numInvs; inv++) {\n    const size = metadata[inv];\n    const id = metadata[inv + numInvs];\n    const res = output[inv];\n    if (filter(id, size)) {\n      const subgroup_id = output[numInvs + inv];\n      const expected_v = expected.get(subgroup_id) ?? 0;\n      if (expected_v !== res) {\n        return new Error(`Invocation ${inv}:\n- expected: ${expected_v}\n-      got: ${res}`);\n      }\n    } else {\n      if (res !== kDataSentinel) {\n        return new Error(`Invocation ${inv} unexpected write:\n- subgroup invocation id: ${id}\n-          subgroup size: ${size}`);\n      }\n    }\n  }\n\n  return undefined;\n}\n\ng.test('compute,all_active')\n  .desc(`Test compute subgroupAny`)\n  .params(u =>\n    u\n      .combine('wgSize', kWGSizes)\n      .beginSubcases()\n      .combine('case', [...iterRange(kNumCases, x => x)])\n  )\n  .beforeAllSubcases(t => {\n    t.selectDeviceOrSkipTestCase('subgroups' as GPUFeatureName);\n  })\n  .fn(async t => {\n    const wgThreads = t.params.wgSize[0] * t.params.wgSize[1] * t.params.wgSize[2];\n\n    const wgsl = `\nenable subgroups;\n\n@group(0) @binding(0)\nvar<storage> inputs : array<u32>;\n\n@group(0) @binding(1)\nvar<storage, read_write> outputs : array<u32>;\n\nstruct Metadata {\n  subgroup_size: array<u32, ${wgThreads}>,\n  subgroup_invocation_id: array<u32, ${wgThreads}>,\n}\n\n@group(0) @binding(2)\nvar<storage, read_write> metadata : Metadata;\n\n@compute @workgroup_size(${t.params.wgSize[0]}, ${t.params.wgSize[1]}, ${t.params.wgSize[2]})\nfn main(\n  @builtin(local_invocation_index) lid : u32,\n  @builtin(subgroup_invocation_id) id : u32,\n  @builtin(subgroup_size) subgroupSize : u32,\n) {\n  metadata.subgroup_size[lid] = subgroupSize;\n\n  metadata.subgroup_invocation_id[lid] = id;\n\n  // Record a representative subgroup id.\n  outputs[lid + ${wgThreads}] = subgroupBroadcastFirst(lid);\n\n  let res = select(0u, 1u, subgroupAny(bool(inputs[lid])));\n  outputs[lid] = res;\n}`;\n\n    const includeCounter = false;\n    const inputData = generateInputData(t.params.case, wgThreads, includeCounter);\n\n    const uintsPerOutput = 2;\n    await runComputeTest(\n      t,\n      wgsl,\n      [t.params.wgSize[0], t.params.wgSize[1], t.params.wgSize[2]],\n      uintsPerOutput,\n      inputData,\n      (metadata: Uint32Array, output: Uint32Array) => {\n        return checkAny(metadata, output, wgThreads, inputData, (id: number, size: number) => {\n          return true;\n        });\n      }\n    );\n  });\n\ng.test('compute,split')\n  .desc('Test that only active invocation participate')\n  .params(u =>\n    u\n      .combine('predicate', keysOf(kPredicateCases))\n      .beginSubcases()\n      .combine('wgSize', kWGSizes)\n      .combine('case', [...iterRange(kNumCases, x => x)])\n  )\n  .beforeAllSubcases(t => {\n    t.selectDeviceOrSkipTestCase('subgroups' as GPUFeatureName);\n  })\n  .fn(async t => {\n    const testcase = kPredicateCases[t.params.predicate];\n    const wgThreads = t.params.wgSize[0] * t.params.wgSize[1] * t.params.wgSize[2];\n\n    const wgsl = `\nenable subgroups;\n\n@group(0) @binding(0)\nvar<storage> inputs : array<u32>;\n\n@group(0) @binding(1)\nvar<storage, read_write> outputs : array<u32>;\n\nstruct Metadata {\n  subgroup_size : array<u32, ${wgThreads}>,\n  subgroup_invocation_id : array<u32, ${wgThreads}>,\n}\n\n@group(0) @binding(2)\nvar<storage, read_write> metadata : Metadata;\n\n@compute @workgroup_size(${t.params.wgSize[0]}, ${t.params.wgSize[1]}, ${t.params.wgSize[2]})\nfn main(\n  @builtin(local_invocation_index) lid : u32,\n  @builtin(subgroup_invocation_id) id : u32,\n  @builtin(subgroup_size) subgroupSize : u32,\n) {\n  metadata.subgroup_size[lid] = subgroupSize;\n\n  // Record subgroup invocation id for this invocation.\n  metadata.subgroup_invocation_id[lid] = id;\n\n  // Record a generated subgroup id.\n  outputs[${wgThreads} + lid] = subgroupBroadcastFirst(lid);\n\n  if ${testcase.cond} {\n    outputs[lid] = select(0u, 1u, subgroupAny(bool(inputs[lid])));\n  } else {\n    return;\n  }\n}`;\n\n    const includeCounter = false;\n    const inputData = generateInputData(t.params.case, wgThreads, includeCounter);\n\n    const uintsPerOutput = 2;\n    await runComputeTest(\n      t,\n      wgsl,\n      [t.params.wgSize[0], t.params.wgSize[1], t.params.wgSize[2]],\n      uintsPerOutput,\n      inputData,\n      (metadata: Uint32Array, output: Uint32Array) => {\n        return checkAny(metadata, output, wgThreads, inputData, testcase.filter);\n      }\n    );\n  });\n\ng.test('fragment').unimplemented();\n"],"mappings":";;GAAA,OAAO,MAAMA,WAAW,GAAI;AAC5B;AACA;AACA;AACA;AACA;AACA;AACA,CAAC,CAED,SAASC,aAAa,QAAQ,kDAAkD;AAChF,SAASC,MAAM,QAAQ,8CAA8C;AACrE,SAASC,SAAS,QAAQ,uCAAuC;AACjE,SAASC,IAAI,QAAQ,6BAA6B;;AAElD;EACEC,QAAQ;EACRC,eAAe;EACfC,YAAY;EACZC,cAAc;EACdC,aAAa;AACR,oBAAoB;;AAE3B,OAAO,MAAMC,CAAC,GAAGT,aAAa,CAACM,YAAY,CAAC;;AAE5C,MAAMI,SAAS,GAAG,EAAE;;AAEpB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,SAASC,iBAAiBA,CAACC,IAAY,EAAEC,GAAW,EAAEC,UAAmB,EAAe;EACtF,MAAMC,IAAI,GAAG,IAAIZ,IAAI,CAACS,IAAI,CAAC;;EAE3B,MAAMI,KAAK,GAAGC,IAAI,CAACC,GAAG,CAACL,GAAG,EAAE,EAAE,CAAC;EAC/B,MAAMM,KAAK,GAAGJ,IAAI,CAACK,UAAU,CAACJ,KAAK,CAAC;;EAEpC,OAAO,IAAIK,WAAW,CAAC;EACrB,GAAGnB,SAAS,CAACW,GAAG,EAAE,CAAAS,CAAC,KAAI;IACrB,IAAIR,UAAU,IAAIQ,CAAC,KAAK,CAAC,EAAE;MACzB;MACA,OAAO,CAAC;IACV;;IAEA,IAAIV,IAAI,KAAK,CAAC,EAAE;MACd,OAAO,CAAC;IACV,CAAC,MAAM,IAAIA,IAAI,KAAK,CAAC,EAAE;MACrB,OAAO,CAAC;IACV,CAAC,MAAM,IAAIA,IAAI,GAAG,EAAE,EAAE;MACpB,MAAMW,OAAO,GAAG,CAACT,UAAU,GAAGQ,CAAC,GAAG,CAAC,GAAGA,CAAC,IAAIN,KAAK;MAChD,OAAOO,OAAO,KAAKJ,KAAK,GAAG,CAAC,GAAG,CAAC;IAClC;IACA,OAAOJ,IAAI,CAACK,UAAU,CAAC,CAAC,CAAC;EAC3B,CAAC,CAAC;EACH,CAAC;AACJ;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,SAASI,QAAQA;AACfC,QAAqB,EAAE;AACvBC,MAAmB;AACnBC,OAAe;AACfC,KAAkB;AAClBC,MAA6C;AAC1B;EACnB;EACA,MAAMC,QAAQ,GAAG,IAAIC,GAAG,CAAiB,CAAC;EAC1C,KAAK,IAAIC,GAAG,GAAG,CAAC,EAAEA,GAAG,GAAGL,OAAO,EAAEK,GAAG,EAAE,EAAE;IACtC,MAAMC,IAAI,GAAGR,QAAQ,CAACO,GAAG,CAAC;IAC1B,MAAME,EAAE,GAAGT,QAAQ,CAACO,GAAG,GAAGL,OAAO,CAAC;IAClC,IAAI,CAACE,MAAM,CAACK,EAAE,EAAED,IAAI,CAAC,EAAE;MACrB;IACF;IACA,MAAME,WAAW,GAAGT,MAAM,CAACC,OAAO,GAAGK,GAAG,CAAC;IACzC,IAAII,CAAC,GAAGN,QAAQ,CAACO,GAAG,CAACF,WAAW,CAAC,IAAI,CAAC;IACtCC,CAAC,IAAIR,KAAK,CAACI,GAAG,CAAC;IACfF,QAAQ,CAACQ,GAAG,CAACH,WAAW,EAAEC,CAAC,CAAC;EAC9B;;EAEA;EACA,KAAK,IAAIJ,GAAG,GAAG,CAAC,EAAEA,GAAG,GAAGL,OAAO,EAAEK,GAAG,EAAE,EAAE;IACtC,MAAMC,IAAI,GAAGR,QAAQ,CAACO,GAAG,CAAC;IAC1B,MAAME,EAAE,GAAGT,QAAQ,CAACO,GAAG,GAAGL,OAAO,CAAC;IAClC,MAAMY,GAAG,GAAGb,MAAM,CAACM,GAAG,CAAC;IACvB,IAAIH,MAAM,CAACK,EAAE,EAAED,IAAI,CAAC,EAAE;MACpB,MAAME,WAAW,GAAGT,MAAM,CAACC,OAAO,GAAGK,GAAG,CAAC;MACzC,MAAMQ,UAAU,GAAGV,QAAQ,CAACO,GAAG,CAACF,WAAW,CAAC,IAAI,CAAC;MACjD,IAAIK,UAAU,KAAKD,GAAG,EAAE;QACtB,OAAO,IAAIE,KAAK,CAAE,cAAaT,GAAI;AAC3C,cAAcQ,UAAW;AACzB,cAAcD,GAAI,EAAC,CAAC;MACd;IACF,CAAC,MAAM;MACL,IAAIA,GAAG,KAAK/B,aAAa,EAAE;QACzB,OAAO,IAAIiC,KAAK,CAAE,cAAaT,GAAI;AAC3C,4BAA4BE,EAAG;AAC/B,4BAA4BD,IAAK,EAAC,CAAC;MAC7B;IACF;EACF;;EAEA,OAAOS,SAAS;AAClB;;AAEAjC,CAAC,CAACkC,IAAI,CAAC,oBAAoB,CAAC;AACzBC,IAAI,CAAE,0BAAyB,CAAC;AAChCC,MAAM,CAAC,CAAAC,CAAC;AACPA,CAAC;AACEC,OAAO,CAAC,QAAQ,EAAE3C,QAAQ,CAAC;AAC3B4C,aAAa,CAAC,CAAC;AACfD,OAAO,CAAC,MAAM,EAAE,CAAC,GAAG7C,SAAS,CAACQ,SAAS,EAAE,CAAAY,CAAC,KAAIA,CAAC,CAAC,CAAC;AACtD,CAAC;AACA2B,iBAAiB,CAAC,CAAAC,CAAC,KAAI;EACtBA,CAAC,CAACC,0BAA0B,CAAC,WAA6B,CAAC;AAC7D,CAAC,CAAC;AACDC,EAAE,CAAC,OAAMF,CAAC,KAAI;EACb,MAAMG,SAAS,GAAGH,CAAC,CAACL,MAAM,CAACS,MAAM,CAAC,CAAC,CAAC,GAAGJ,CAAC,CAACL,MAAM,CAACS,MAAM,CAAC,CAAC,CAAC,GAAGJ,CAAC,CAACL,MAAM,CAACS,MAAM,CAAC,CAAC,CAAC;;EAE9E,MAAMC,IAAI,GAAI;AAClB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,8BAA8BF,SAAU;AACxC,uCAAuCA,SAAU;AACjD;AACA;AACA;AACA;AACA;AACA,2BAA2BH,CAAC,CAACL,MAAM,CAACS,MAAM,CAAC,CAAC,CAAE,KAAIJ,CAAC,CAACL,MAAM,CAACS,MAAM,CAAC,CAAC,CAAE,KAAIJ,CAAC,CAACL,MAAM,CAACS,MAAM,CAAC,CAAC,CAAE;AAC5F;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,kBAAkBD,SAAU;AAC5B;AACA;AACA;AACA,EAAE;;EAEE,MAAMG,cAAc,GAAG,KAAK;EAC5B,MAAMC,SAAS,GAAG9C,iBAAiB,CAACuC,CAAC,CAACL,MAAM,CAACa,IAAI,EAAEL,SAAS,EAAEG,cAAc,CAAC;;EAE7E,MAAMG,cAAc,GAAG,CAAC;EACxB,MAAMpD,cAAc;IAClB2C,CAAC;IACDK,IAAI;IACJ,CAACL,CAAC,CAACL,MAAM,CAACS,MAAM,CAAC,CAAC,CAAC,EAAEJ,CAAC,CAACL,MAAM,CAACS,MAAM,CAAC,CAAC,CAAC,EAAEJ,CAAC,CAACL,MAAM,CAACS,MAAM,CAAC,CAAC,CAAC,CAAC;IAC5DK,cAAc;IACdF,SAAS;IACT,CAAChC,QAAqB,EAAEC,MAAmB,KAAK;MAC9C,OAAOF,QAAQ,CAACC,QAAQ,EAAEC,MAAM,EAAE2B,SAAS,EAAEI,SAAS,EAAE,CAACvB,EAAU,EAAED,IAAY,KAAK;QACpF,OAAO,IAAI;MACb,CAAC,CAAC;IACJ;EACF,CAAC;AACH,CAAC,CAAC;;AAEJxB,CAAC,CAACkC,IAAI,CAAC,eAAe,CAAC;AACpBC,IAAI,CAAC,8CAA8C,CAAC;AACpDC,MAAM,CAAC,CAAAC,CAAC;AACPA,CAAC;AACEC,OAAO,CAAC,WAAW,EAAE9C,MAAM,CAACI,eAAe,CAAC,CAAC;AAC7C2C,aAAa,CAAC,CAAC;AACfD,OAAO,CAAC,QAAQ,EAAE3C,QAAQ,CAAC;AAC3B2C,OAAO,CAAC,MAAM,EAAE,CAAC,GAAG7C,SAAS,CAACQ,SAAS,EAAE,CAAAY,CAAC,KAAIA,CAAC,CAAC,CAAC;AACtD,CAAC;AACA2B,iBAAiB,CAAC,CAAAC,CAAC,KAAI;EACtBA,CAAC,CAACC,0BAA0B,CAAC,WAA6B,CAAC;AAC7D,CAAC,CAAC;AACDC,EAAE,CAAC,OAAMF,CAAC,KAAI;EACb,MAAMU,QAAQ,GAAGvD,eAAe,CAAC6C,CAAC,CAACL,MAAM,CAACgB,SAAS,CAAC;EACpD,MAAMR,SAAS,GAAGH,CAAC,CAACL,MAAM,CAACS,MAAM,CAAC,CAAC,CAAC,GAAGJ,CAAC,CAACL,MAAM,CAACS,MAAM,CAAC,CAAC,CAAC,GAAGJ,CAAC,CAACL,MAAM,CAACS,MAAM,CAAC,CAAC,CAAC;;EAE9E,MAAMC,IAAI,GAAI;AAClB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,+BAA+BF,SAAU;AACzC,wCAAwCA,SAAU;AAClD;AACA;AACA;AACA;AACA;AACA,2BAA2BH,CAAC,CAACL,MAAM,CAACS,MAAM,CAAC,CAAC,CAAE,KAAIJ,CAAC,CAACL,MAAM,CAACS,MAAM,CAAC,CAAC,CAAE,KAAIJ,CAAC,CAACL,MAAM,CAACS,MAAM,CAAC,CAAC,CAAE;AAC5F;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,YAAYD,SAAU;AACtB;AACA,OAAOO,QAAQ,CAACE,IAAK;AACrB;AACA;AACA;AACA;AACA,EAAE;;EAEE,MAAMN,cAAc,GAAG,KAAK;EAC5B,MAAMC,SAAS,GAAG9C,iBAAiB,CAACuC,CAAC,CAACL,MAAM,CAACa,IAAI,EAAEL,SAAS,EAAEG,cAAc,CAAC;;EAE7E,MAAMG,cAAc,GAAG,CAAC;EACxB,MAAMpD,cAAc;IAClB2C,CAAC;IACDK,IAAI;IACJ,CAACL,CAAC,CAACL,MAAM,CAACS,MAAM,CAAC,CAAC,CAAC,EAAEJ,CAAC,CAACL,MAAM,CAACS,MAAM,CAAC,CAAC,CAAC,EAAEJ,CAAC,CAACL,MAAM,CAACS,MAAM,CAAC,CAAC,CAAC,CAAC;IAC5DK,cAAc;IACdF,SAAS;IACT,CAAChC,QAAqB,EAAEC,MAAmB,KAAK;MAC9C,OAAOF,QAAQ,CAACC,QAAQ,EAAEC,MAAM,EAAE2B,SAAS,EAAEI,SAAS,EAAEG,QAAQ,CAAC/B,MAAM,CAAC;IAC1E;EACF,CAAC;AACH,CAAC,CAAC;;AAEJpB,CAAC,CAACkC,IAAI,CAAC,UAAU,CAAC,CAACoB,aAAa,CAAC,CAAC"}